@page
@model MultiplicationGame.Pages.EquationsModel
@{
    ViewData["Title"] = "Równania";
}

<h1>Równania</h1>

@if (Model.Score != null)
{
    <div class="alert alert-warning">
        <strong>DEBUG:</strong> Score = @Model.Score, Equations.Count = @Model.Equations.Count, 
        Answers = @(Model.Answers != null ? string.Join(", ", Model.Answers) : "null")
        <br/>
        IsCorrect values: @string.Join(", ", Model.Equations.Select((eq, i) => $"{i}: {eq.IsCorrect?.ToString() ?? "null"}"))
    </div>
}

<form method="post">
    <div class="mb-3">
        <label for="difficulty" class="form-label">Poziom trudności</label>
        <select id="difficulty" name="Difficulty" class="form-select" onchange="this.form.submit()">
            <option value="2" selected="@(Model.Difficulty=="2")">Klasa 2</option>
            <option value="3" selected="@(Model.Difficulty=="3")">Klasa 3</option>
        </select>
        <input type="hidden" name="handler" value="Generate" />
    </div>
</form>

<form method="post">
    <input type="hidden" name="Difficulty" value="@Model.Difficulty" />
    <input type="hidden" name="handler" value="Submit" />

    <div class="row">
        <div class="col-md-6">
            <ol>
                @for (int i = 0; i < Model.Equations.Count / 2; i++)
                {
                    var eq = Model.Equations[i];
                    <li class="mb-3">
                        <div class="card equation-card @(eq.IsCorrect == true ? "correct" : (eq.IsCorrect == false ? "incorrect" : ""))">
                            <div class="d-flex align-items-center w-100">
                                <div class="equation-text operand-display display-3 flex-grow-1 me-3">@eq.Text =</div>
                                <div class="d-flex flex-column align-items-end">
                                    <input type="text" name="Answers" value="@(Model.Answers != null && i < Model.Answers.Count ? Model.Answers[i] : "")" class="form-control equation-input mb-1" style="min-width:120px; font-size: 1.75rem !important; font-weight: 600;" aria-label="Odpowiedź dla równania @i" />
                                    @if (eq.IsCorrect != null)
                                    {
                                        if (eq.IsCorrect == true)
                                        {
                                            <div class="text-success small">Poprawnie</div>
                                        }
                                        else
                                        {
                                            <div class="text-danger small">Błąd — prawidłowo: @eq.Answer</div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="Equations[@i].Text" value="@eq.Text" />
                        <input type="hidden" name="Equations[@i].Answer" value="@eq.Answer" />
                    </li>
                }
            </ol>
        </div>
        <div class="col-md-6">
            <ol start="@(Model.Equations.Count/2 + 1)">
                @for (int i = Model.Equations.Count / 2; i < Model.Equations.Count; i++)
                {
                    var eq = Model.Equations[i];
                    <li class="mb-3">
                        <div class="card equation-card @(eq.IsCorrect == true ? "correct" : (eq.IsCorrect == false ? "incorrect" : ""))">
                            <div class="d-flex align-items-center w-100">
                                <div class="equation-text operand-display display-3 flex-grow-1 me-3">@eq.Text =</div>
                                <div class="d-flex flex-column align-items-end">
                                    <input type="text" name="Answers" value="@(Model.Answers != null && i < Model.Answers.Count ? Model.Answers[i] : "")" class="form-control equation-input mb-1" style="min-width:120px; font-size: 1.75rem !important; font-weight: 600;" aria-label="Odpowiedź dla równania @i" />
                                    @if (eq.IsCorrect != null)
                                    {
                                        if (eq.IsCorrect == true)
                                        {
                                            <div class="text-success small">Poprawnie</div>
                                        }
                                        else
                                        {
                                            <div class="text-danger small">Błąd — prawidłowo: @eq.Answer</div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="Equations[@i].Text" value="@eq.Text" />
                        <input type="hidden" name="Equations[@i].Answer" value="@eq.Answer" />
                    </li>
                }
            </ol>
        </div>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Sprawdź odpowiedzi</button>
        <a class="btn btn-secondary ms-2" href="?handler=Generate&Difficulty=@Model.Difficulty">Losuj ponownie</a>
    </div>

    @if (Model.Score != null)
    {
        <div class="mt-3 alert alert-info">Wynik: @Model.Score / @Model.Equations.Count</div>
    }
</form>

<script>
(function() {
    // Wait for the submit form which contains handler=Submit
    const submitHandlerInput = document.querySelector('input[name="handler"][value="Submit"]');
    if (!submitHandlerInput) {
        console.error('Submit handler input not found');
        return;
    }
    const form = submitHandlerInput.closest('form');
    if (!form) {
        console.error('Form not found');
        return;
    }

    const answerSelector = 'input[name="Answers"]';
    const hiddenTextSelector = 'input[name*=".Text"]';

    const answers = () => Array.from(form.querySelectorAll(answerSelector));
    const hiddenTexts = () => Array.from(form.querySelectorAll(hiddenTextSelector));

    function markEmpty() {
        answers().forEach(i => i.classList.toggle('empty', !i.value || i.value.trim() === ''));
    }

    function setValidationMessage(input, msg) {
        let el = input.nextElementSibling;
        if (!el || !el.classList || !el.classList.contains('validation-msg')) {
            el = document.createElement('div');
            el.className = 'validation-msg text-danger small';
            input.parentNode.appendChild(el);
        }
        el.textContent = msg || '';
        el.style.display = msg ? 'block' : 'none';
    }

    function clearValidationMessage(input) { setValidationMessage(input, ''); }

    function isIntegerString(s) {
        if (!s) return false;
        s = s.trim();
        return /^[-+]?\d+$/.test(s);
    }

    function validateField(idx) {
        const input = answers()[idx];
        if (!input) return false;
        
        const raw = input.value ? input.value.trim() : '';
        input.classList.remove('empty', 'invalid');
        clearValidationMessage(input);

        if (!raw) {
            input.classList.add('empty');
            setValidationMessage(input, 'Wprowadź odpowiedź');
            return false;
        }

        const texts = hiddenTexts();
        const text = (texts[idx] && texts[idx].value) || '';
        const op = (text.includes('÷') || text.includes('/')) ? '/' : (text.includes('×') || text.includes('x') || text.includes('*')) ? '*' : (text.includes('+') ? '+' : '-');

        const normalized = raw.replace(',', '.');
        const num = Number(normalized);
        if (Number.isNaN(num)) {
            input.classList.add('invalid');
            setValidationMessage(input, 'Nieprawidłowa liczba');
            return false;
        }

        if (op === '+' || op === '-' || op === '*') {
            if (!isIntegerString(raw.replace(',', '.'))) {
                input.classList.add('invalid');
                setValidationMessage(input, 'Wymagana liczba całkowita');
                return false;
            }
        }

        clearValidationMessage(input);
        input.classList.remove('invalid');
        return true;
    }

    function validateAll() {
        markEmpty();
        const list = answers();
        let ok = true;
        for (let i = 0; i < list.length; i++) {
            if (!validateField(i)) ok = false;
        }
        return ok;
    }

    // intercept Enter on answer fields
    form.addEventListener('keydown', function(e) {
        const target = e.target;
        if (!target || !target.matches) return;
        if (e.key === 'Enter' && target.matches(answerSelector)) {
            e.preventDefault();
            
            const allAnswers = answers();
            const currentIdx = allAnswers.indexOf(target);
            if (currentIdx >= 0) {
                validateField(currentIdx);
            }
            
            if (validateAll()) {
                form.submit();
                return;
            }
            
            const nextEmpty = allAnswers.find((inp, idx) => idx > currentIdx && (!inp.value || inp.value.trim() === ''));
            if (nextEmpty) {
                nextEmpty.focus();
            } else {
                const firstProblem = form.querySelector(answerSelector + '.empty, ' + answerSelector + '.invalid');
                if (firstProblem) firstProblem.focus();
            }
            return false;
        }
    });

    // on form submit
    form.addEventListener('submit', function(e) {
        const isValid = validateAll();
        if (!isValid) {
            e.preventDefault();
            const firstInvalid = form.querySelector(answerSelector + '.empty, ' + answerSelector + '.invalid');
            if (firstInvalid) firstInvalid.focus();
            return false;
        }
        return true;
    });

    // live input validation
    form.addEventListener('input', function(e) {
        const t = e.target;
        if (t && t.matches && t.matches(answerSelector)) {
            validateField(Array.from(answers()).indexOf(t));
        }
    });
})();
</script>
