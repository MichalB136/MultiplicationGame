@page
@model MultiplicationGame.Pages.EquationsModel
@{
    ViewData["Title"] = "Równania";
}

<h1>Równania</h1>

<form method="post" asp-page-handler="Generate" class="mb-3">
    <label for="difficulty" class="form-label">Poziom trudności</label>
    <select id="difficulty" name="Difficulty" class="form-select" onchange="this.form.submit()">
        <option value="1" selected="@(Model.Difficulty=="1")">Klasa 1</option>
        <option value="2" selected="@(Model.Difficulty=="2")">Klasa 2</option>
        <option value="3" selected="@(Model.Difficulty=="3")">Klasa 3</option>
    </select>
    @Html.AntiForgeryToken()
    <input type="hidden" name="TotalAnswered" value="@Model.TotalAnswered" />
    <input type="hidden" name="A" value="@Model.A" />
    <input type="hidden" name="B" value="@Model.B" />
    <input type="hidden" name="Operator" value="@Model.Operator" />
    <input type="hidden" name="UserAnswer" value="@Model.UserAnswer" />
    <input type="hidden" name="HistoryRaw" value='@Model.HistoryRaw' />
    <noscript>
        <button type="submit" class="btn btn-outline-primary mt-2">Zmień poziom</button>
    </noscript>
    
    <div class="mt-3">
        <div class="d-flex flex-wrap gap-2">
            @for (var i = 1; i <= Model.RequiredAnswers; i++)
            {
                if (i <= Model.History.Count)
                {
                    var ok = Model.History[i-1].IsCorrect;
                    <div class="badge @(ok ? "bg-success" : "bg-danger")">@i</div>
                }
                else
                {
                    var isCurrent = i == (Model.History.Count + 1) && !Model.GameFinished;
                    <div class="badge @(isCurrent ? "bg-warning text-dark" : "bg-secondary")">@i</div>
                }
            }
        </div>
    </div>
</form>

@if (!Model.GameFinished)
{
<form method="post" asp-page-handler="Submit" class="card p-4 current-question-card" id="equationsAnswerForm">
    @Html.AntiForgeryToken()
    <input type="hidden" name="Difficulty" value="@Model.Difficulty" />
    <input type="hidden" name="A" value="@Model.A" />
    <input type="hidden" name="B" value="@Model.B" />
    <input type="hidden" name="Operator" value="@Model.Operator" />
    <input type="hidden" name="TotalAnswered" value="@Model.TotalAnswered" />
    <input type="hidden" name="HistoryRaw" value='@Model.HistoryRaw' />

    @{
        if (Model.ModelState.TryGetValue("UserAnswer", out var userAnswerErrors) && userAnswerErrors.Errors.Count > 0)
        {
            <div class="alert alert-danger" role="alert">
                <strong>Błąd walidacji:</strong>
                @foreach (var error in userAnswerErrors.Errors)
                {
                    <div>@error.ErrorMessage</div>
                }
            </div>
        }
    }

    <div class="d-flex align-items-center justify-content-center mb-3">
        <div class="display-3 me-3 operand-display">@Model.A</div>
        <div class="display-3 me-3 operand-display">@Model.Operator</div>
        <div class="display-3 me-3 operand-display">@Model.B</div>
        <div class="display-3 me-3 operand-display">=</div>
         <input type="text"
             name="UserAnswer"
             value="@Model.UserAnswer"
             class="form-control equation-input numeric-input"
             style="max-width:180px; font-size:2rem; font-weight:600;"
             autocomplete="off"
               inputmode="decimal"
               pattern="-?(?:[0-9]+(?:[.,][0-9]+)?|[.,][0-9]+)"
               title="Wpisz liczbę (może być ułamek dziesiętny, dopuszczalne . lub ,)" />
    </div>

    @if (Model.AnswerChecked)
    {
        if (Model.IsCorrect)
        {
            <div class="alert alert-success">Dobrze!</div>
        }
        else
        {
            <div class="alert alert-danger">Niepoprawnie. Poprawna odpowiedź: @Model.CorrectAnswer</div>
        }
    }

    <div class="d-flex gap-2">
        @if (!Model.AnswerChecked)
        {
            <button type="submit" class="btn btn-primary">Sprawdź</button>
        }
        else
        {
            <input type="hidden" name="NextQuestion" value="true" />
            <button type="submit" class="btn btn-secondary">Następne pytanie</button>
        }
    </div>
</form>
}
else
{
    <div class="card p-4">
        <h4 class="mb-3">Podsumowanie</h4>
        <ul class="list-group mb-3">
            @foreach (var h in Model.History)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center @(h.IsCorrect ? "list-group-item-success" : "list-group-item-danger")">
                    <span class="fw-bold">@h.Text</span>
                    @if (h.IsCorrect)
                    {
                        <span>Poprawnie</span>
                    }
                    else
                    {
                        <span>Błąd — prawidłowo: @h.Correct</span>
                    }
                </li>
            }
        </ul>
        <form method="post" asp-page-handler="Generate">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Difficulty" value="@Model.Difficulty" />
            <button type="submit" class="btn btn-primary">Zacznij ponownie</button>
        </form>
    </div>
}

<script>
// Focus answer on load
setTimeout(() => {
  const inp = document.querySelector('input[name="UserAnswer"]');
  if (inp) inp.focus();
}, 0);

// Guard against double-submit - reset after answer checked
(function(){
    const form = document.getElementById('equationsAnswerForm');
    if (!form) return;
    
    // Check if we're showing "Następne pytanie" button and reset guard
    const nextQuestionField = form.querySelector('input[name="NextQuestion"][value="true"]');
    if (nextQuestionField) {
        form.dataset.submitted = 'false';
        // Re-enable buttons
        const btns = form.querySelectorAll('button[type="submit"]');
        btns.forEach(b => b.removeAttribute('disabled'));
    }
    
    form.addEventListener('submit', function(e){
        // Double-submit prevention only (validation handled by site.js submit guard)
        if (form.dataset.submitted === 'true') {
            e.preventDefault();
            return false;
        }
        form.dataset.submitted = 'true';
        const btns = form.querySelectorAll('button[type="submit"]');
        btns.forEach(b => b.setAttribute('disabled','disabled'));
    });
})();
</script>

<style>
.current-question-card:not(.answered) {
    box-shadow: 0 0 0.75rem rgba(255, 193, 7, 0.55);
    border: 2px solid #ffc107;
}
</style>
